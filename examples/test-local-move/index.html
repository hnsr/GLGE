<!-- This was a test to see if my patch to placable.move() worked. It does fix the issue with the
camera not translating correctly, but then breaks translating actual placables themselfes, so the
bug is in the camera class.. and it needs to be fixed in there. -->
<html>
    <head>
        <title>GLGE test</title>
        <script type="text/javascript" src="../../glge-compiled.js"></script>
        <style>
            body { margin: 0; }
            p { position: fixed; top: 10px; left: 10px;}
        </style>
    </head>
    <body>
        <canvas id="canvas" width="500" height="500"></canvas>
        <p id="stat">stat</p>

        <script id="glge_document" type="text/xml">
            <glge>
                <mesh id="xline">
                    <positions>
                        -50.0,0,0,
                        50.0,0,0
                    </positions>
                </mesh>
                <mesh id="northline">
                    <positions>
                        0,0,0,
                        0,0,-50
                    </positions>
                </mesh>
                <mesh id="zline">
                    <positions>
                        0,0,-50,
                        0,0,50
                    </positions>
                </mesh>

                <material id="darkline" specular="0" color="#333" shadeless="1" />
                <material id="lines"    specular="0" color="#777" shadeless="1" />

                <scene id="mainscene" ambient_color="#333" background_color="#888" fog_near="5"
                       fog_far="60" fog_color="#555" fog_type="FOG_LINEAR" camera="#mainCamera">
                    <group id="graph">
                        <object id="xaxis"     draw_type="DRAW_LINES" line_width="2" mesh="#xline"     material="#darkline" />
                        <object id="zaxis"     draw_type="DRAW_LINES" line_width="2" mesh="#zline"     material="#darkline" />
                        <object id="northaxis" draw_type="DRAW_LINES" line_width="4" mesh="#northline" material="#darkline" />
                    </group>

                    <group id="camerag" loc_z="0">
                        <camera id="mainCamera" loc_z="20" loc_y="1" loc_x="0" rot_x="0" rot_y="0" />
                    </group>

                    <light id="light" loc_x="0"   loc_y="20" loc_z="10" rot_x="0" rot_y="1.57" attenuation_constant="0.9" type="L_DIR" />
                    <light id="light" loc_x="-10" loc_y="20" loc_z="-5" rot_x="-1.3" attenuation_constant="5" type="L_POINT" />
                    <light id="light" loc_x="-10" loc_y="20" loc_z="10" rot_x="-1.3" attenuation_constant="5" type="L_POINT" />
                </scene>
            </glge>
        </script>

        <script>

            function stat(text) { document.getElementById("stat").innerHTML = text; }

            function lookAt(origin, point)
            {
                var coord = [origin[0]-point[0],
                             origin[1]-point[1],
                             origin[2]-point[2]];

                var zvec = GLGE.toUnitVec3(coord);
                var xvec = GLGE.toUnitVec3(GLGE.crossVec3([0,1,0],zvec));
                var yvec = GLGE.toUnitVec3(GLGE.crossVec3(zvec,xvec));

                return [xvec[0], yvec[0], zvec[0], 0,
                        xvec[1], yvec[1], zvec[1], 0,
                        xvec[2], yvec[2], zvec[2], 0,
                              0,       0,       0, 1 ];
            }

            function updateScene(delta)
            {
                
                var move = moveSpeed*(delta/1000);
                //stat("moving by " + move);

                if (movingLeft)    camera.move([-move, 0, 0], GLGE.LOCAL);
                if (movingRight)   camera.move([ move, 0, 0], GLGE.LOCAL);
                if (movingForward) camera.move([0, 0, -move], GLGE.LOCAL);
                if (movingBack)    camera.move([0, 0,  move], GLGE.LOCAL);
                if (movingUp)      camera.move([0,  move, 0], GLGE.LOCAL);
                if (movingDown)    camera.move([0, -move, 0], GLGE.LOCAL);
            }

            function generateFloorGrid(XMLdoc)
            {
                var positions = [];
                var scene = XMLdoc.getElement("mainscene");

                for(var x =- 50; x < 50; x++)
                {
                    if (x != 0)
                    {
                        positions.push(x);   positions.push(0); positions.push(-50);
                        positions.push(x);   positions.push(0); positions.push(50);
                        positions.push(50);  positions.push(0); positions.push(x);
                        positions.push(-50); positions.push(0); positions.push(x);
                    }
                }

                var grid = (new GLGE.Object).setDrawType(GLGE.DRAW_LINES);

                grid.setMesh((new GLGE.Mesh).setPositions(positions));
                grid.setMaterial(XMLdoc.getElement("lines"));
                scene.addObject(grid);
            }

            var canvas = document.getElementById( 'canvas' );

            canvas.width  = innerWidth;
            canvas.height = innerHeight;

            var view = false;

            var mouseStartX = 0;
            var mouseStartY = 0;
            var mouseSens       = 1/1000;
            var mouseScrollSens = 1/400;

            var moveSpeed = 1;

            var KEY_E     = 69;
            var KEY_D     = 68;
            var KEY_S     = 83;
            var KEY_F     = 70;
            var KEY_T     = 84;
            var KEY_G     = 71;
            var KEY_SPACE = 32;

            var movingForward, movingBack, movingLeft, movingRight, movingUp, movingDown;

            window.onkeydown = function (e)
            {
                stat("key down " + e.which);
                var key = e.which;
                if (key == KEY_E) movingForward = true;
                if (key == KEY_D) movingBack    = true;
                if (key == KEY_S) movingLeft    = true;
                if (key == KEY_F) movingRight   = true;
                if (key == KEY_T || key == KEY_SPACE) movingUp = true;
                if (key == KEY_G) movingDown    = true;
            }

            window.onkeyup = function (e)
            {
                stat("key up " + e.which);
                var key = e.which;
                if (key == KEY_E) movingForward = false;
                if (key == KEY_D) movingBack    = false;
                if (key == KEY_S) movingLeft    = false;
                if (key == KEY_F) movingRight   = false;
                if (key == KEY_T || key == KEY_SPACE) movingUp = false;
                if (key == KEY_G) movingDown    = false;
            }

            canvas.onmousedown = function(e)
            {
                if (e.button == 0)
                {
                    view = true;
                    mouseStartX = e.clientX;
                    mouseStartY = e.clientY;
                }
                e.preventDefault();
            }

            canvas.onmouseup = function (e) { view = false; }

            canvas.onmousemove = function (e)
            {
                if (view)
                {
                    var dX = e.clientX - mouseStartX;
                    var dY = e.clientY - mouseStartY;

                    mouseStartX = e.clientX;
                    mouseStartY = e.clientY;

                    camera.setRotY(Number(camera.getRotY()) + (-dX) * mouseSens);
                    camera.setRotX(Number(camera.getRotX()) +    dY * mouseSens);
                }
            }

            canvas.onmousewheel = function(e)
            {
                var dWheel = e.wheelDelta * mouseScrollSens;

                camerag.setLocY(Number(camerag.getLocY())+dWheel);
                //camera.setRotMatrix(lookAt([0, cameraPos[1], 0], [0, 2, -cameraPos[2]]));
            }
            canvas.addEventListener('DOMMouseScroll', canvas.onmousewheel, false);

            canvas.oncontextmenu = function(e) { return false; }

            var renderer = new GLGE.Renderer(canvas);
            var XMLdoc   = new GLGE.Document();

            var camera;
            var camerag;

            XMLdoc.onLoad = function()
            {
                var scene = XMLdoc.getElement( "mainscene" );
                camera    = XMLdoc.getElement( "mainCamera" );
                camerag   = XMLdoc.getElement( "camerag" );

                generateFloorGrid(XMLdoc);

                renderer.setScene( scene );

                // Main loop
                var frameCount = 0,
                    curTime    = 0,
                    lastTime   = Date.now(),
                    timeDelta  = 0;

                (function frame()
                {
                    requestAnimationFrame(frame);

                    frameCount++;

                    curTime = Date.now();
                    timeDelta = curTime - lastTime;
                    lastTime = curTime;

                    // Update FPS when fpsInterval ms has passed
                    /*
                    if ((curTime - lastFPSTime) > fpsInterval)
                    {
                        fps = Math.round((frameCount-lastFPSFrameCount)*10 / ((curTime-lastFPSTime)/1000))/10;
                        lastFPSTime = curTime;
                        lastFPSFrameCount = frameCount;
                    }
                    */
                    updateScene(timeDelta);

                    renderer.render();
                })();
            }

            XMLdoc.parseScript("glge_document");

        </script>
    </body>
</html>
